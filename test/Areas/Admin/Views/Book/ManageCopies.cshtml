@model test.Areas.Admin.Models.BookViewModel
@using X.PagedList.Mvc.Core

@{
    ViewData["Title"] = "Manage Book Copies";
    ViewData["Navigation Title"] = "Manage Book Copies";
}

<div class="row mt-5 g-3">
    <div class="col-12">
        <div class="card border-0 shadow-sm h-100 overflow-auto">
            <div class="card-body">
                <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
                    <ol class="breadcrumb text-color4">
                        <li class="breadcrumb-item"><a asp-controller="Book" asp-action="Index" class="text-color3 fw-bold">Books</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Manage Book Copies</li>
                    </ol>
                </nav>

                <hr />
                @await Html.PartialAsync("~/Areas/Admin/Views/Shared/Partials/_ToastNotification.cshtml")

                <!-- 📌 Book Details -->
                <div class="row mb-3">
                    <div class="col-12 col-sm-3 col-md-3 col-lg-2">
                        <span class="fw-bold">Book</span>
                    </div>
                    <div class="col-12 col-sm-9 col-md-9 col-lg-10">
                        <div class="row">
                            <div class="col">
                                <label>Title</label>
                                <h5>@Model.Title</h5>
                            </div>
                            <div class="col">
                                <label>Total Copies</label>
                                <h5>@Model.BookCopies</h5>
                            </div>
                        </div>
                    </div>
                </div>

                <hr />

                <!-- 📌 Add Copies -->
                <div class="row mb-3">
                    <div class="col-6 col-sm-3 col-md-3 col-lg-2">
                        <span class="fw-bold">Copies</span>
                    </div>
                    <div class="col-6 col-sm-9 col-md-9 col-lg-10">
                        <a data-bs-toggle="modal" data-bs-target="#addCopyModal-@Model.Id"
                           class="btn btn-sm bg-color3 px-3 d-flex align-items-center justify-content-start"
                           title="Add New Book Copies" style="width:120px;">
                            <i class="ri-add-circle-line"></i>
                            <span class="ms-1 fw-bold">New Copy</span>
                        </a>
                    </div>
                </div>

                <!-- 📌 Copies Table -->
                <div class="row">
                    <div class="col-12 col-sm-9 col-md-9 col-lg-10 offset-sm-3 offset-md-3 offset-lg-2">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Copy No.</th>
                                    <th>Status</th>
                                    <th>QR Code</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var copy in Model.Copies)
                                {
                                    <tr>
                                        <td>@copy.CopyNumber</td>
                                        <td>
                                            <span class="badge
                                                    @(copy.Status switch
                                                  {
                                                      "Available" => "bg-success",
                                                      "Borrowed" => "bg-info",
                                                      "Damaged" => "bg-danger",
                                                      "Lost" => "bg-secondary",
                                                      "Overdue" => "bg-warning",
                                                      "Unavailable" => "bg-dark",
                                                      "Archived" => "bg-secondary",
                                                      _ => "bg-primary"
                                                  })">
                                            @copy.Status
                                        </span>

                                        @if (copy.Status != "Archived")
                                            {
                                                <a data-bs-toggle="modal" data-bs-target="#editStatusModal-@copy.Id"
                                                   class="btn bg-transparent btn-sm" title="Edit Status">
                                                    <i class="ri-pencil-line"></i>
                                                </a>
                                            }
                                        </td>

                                        <td>
                                            @if (!string.IsNullOrEmpty(copy.QrCodePath))
                                            {
                                                <a href="#" data-bs-toggle="modal" data-bs-target="#qrModal-@copy.Id">
                                                    <img src="@copy.QrCodePath" alt="QR Code" width="60" height="60" class="img-thumbnail" />
                                                </a>
                                            }
                                            else
                                            {
                                                <span class="text-muted">No QR</span>
                                            }
                                        </td>

                                        <td>
                                            @if (copy.Status != "Archived")
                                            {
                                                <!-- Archive Button -->
                                                <a class="btn btn-sm btn-warning"
                                                   data-bs-toggle="modal"
                                                   data-bs-target="#archiveCopy-@copy.Id">
                                                    <i class="ri-archive-line me-1"></i> Archive
                                                </a>
                                            }
                                            else
                                            {
                                                <span class="text-muted">Archived on @copy.ArchivedAt?.ToString("yyyy-MM-dd")</span>
                                        
                                                <br />
                                                <small class="text-muted">Reason: @copy.ArchiveReason</small>
                                            }
                                        </td>
                                    </tr>

                                    @* <a data-bs-toggle="modal" data-bs-target="#archiveCopy-@copy.Id" class="btn btn-sm btn-warning">
                                        Archive
                                    </a> *@

                                    <!-- Archive Modal -->
                                    <div class="modal fade" id="archiveCopy-@copy.Id" tabindex="-1">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <form asp-action="ArchiveCopy" method="post">
                                                    <input type="hidden" name="id" value="@copy.Id" />
                                                    <div class="modal-header">
                                                        <h5 class="modal-title">Archive Copy @copy.CopyNumber</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <label for="reason">Reason</label>
                                                        <textarea name="reason" class="form-control" required></textarea>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="submit" class="btn btn-warning">Archive</button>
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>


                                    <!-- QR Modal (existing) -->
                                    <div class="modal fade" id="qrModal-@copy.Id" tabindex="-1" aria-labelledby="qrModalLabel-@copy.Id" aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-centered">
                                            <div class="modal-content border-0 shadow-lg">
                                                <div class="modal-header bg-color3 text-white">
                                                    <h5 class="modal-title">Book Copy QR</h5>
                                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                                </div>
                                                <div class="modal-body text-center">
                                                    <img src="@copy.QrCodePath" alt="QR Code" class="img-fluid mb-3" style="max-width: 250px;" />
                                                    <h6 class="fw-bold">Copy Number: @copy.CopyNumber</h6>
                                                    <p>
                                                        Status:
                                                        <span class="badge
                                                                @(copy.Status switch
                                                              {
                                                                  "Available" => "bg-success",
                                                                  "Borrowed" => "bg-info",
                                                                  "Damaged" => "bg-danger",
                                                                  "Lost" => "bg-secondary",
                                                                  "Overdue" => "bg-warning",
                                                                  "Unavailable" => "bg-dark",
                                                                  "Archived" => "bg-secondary",
                                                                  _ => "bg-primary"
                                                              })">
                                                            @copy.Status
                                                        </span>
                                                    </p>
                                                    <a href="@copy.QrCodePath" download="QR-@copy.CopyNumber" class="btn bg-color3 text-white px-3">
                                                        <i class="ri-download-2-line me-1"></i> Download QR
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </tbody>
                        </table>

                        <!-- Pagination -->
                        <div class="d-flex justify-content-start mt-3">
                            @Html.PagedListPager(Model.Copies, page => Url.Action("ManageCopies", new { id = Model.Id, page }),
                            new PagedListRenderOptions
                            {
                                LiElementClasses = new[] { "page-item", "custom-page-item" },
                                PageClasses = new[] { "page-link", "custom-page-link" }
                            })
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
@await Html.PartialAsync("~/Areas/Admin/Views/Book/Modals/AddBookCopy.cshtml")
@await Html.PartialAsync("~/Areas/Admin/Views/Book/Modals/EditStatus.cshtml")