@model test.Areas.Admin.Models.DashboardViewModel

@{
    ViewData["Title"] = "Dashboard";
    ViewData["Navigation Title"] = "Dashboard";
}

<style>
    .stat-card-new {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background: white;
        transition: all 0.2s ease;
    }

        .stat-card-new:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .stat-card-new .card-body {
            padding: 1.25rem;
            position: relative;
        }

        .stat-card-new.accent-indigo {
            border-left: 4px solid #6366f1;
        }

        .stat-card-new.accent-purple {
            border-left: 4px solid #8b5cf6;
        }

        .stat-card-new.accent-green {
            border-left: 4px solid #10b981;
        }

        .stat-card-new.accent-cyan {
            border-left: 4px solid #06b6d4;
        }

    .stat-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
    }

    .stat-icon {
        font-size: 18px;
        color: #6b7280;
    }

    .stat-label {
        font-size: 14px;
        font-weight: 500;
        color: #6b7280;
        margin: 0;
    }

    .stat-value {
        font-size: 1.875rem;
        font-weight: 600;
        color: #111827;
        margin: 0;
    }

    .chart-container {
        position: relative;
        height: 220px; 
        width: 100%; 
    }
</style>

<div class="container-fluid mt-3">
    <!-- Welcome card -->
    <div class="card mb-4 bg-light border-0 shadow-sm">
        <div class="card-body p-3 p-lg-4">
            <div class="row g-4 align-items-center">
                <div class="col-lg-7">
                    <h5 class="text-primary fw-semibold">Welcome back to ShelfMaster!</h5>
                    <p class="text-muted mb-0">
                        Your library dashboard is ready. Here you can track borrowed books,
                        manage transactions, and stay updated with your collection's activity.
                        Explore your stats and keep your library running smoothly.
                    </p>
                </div>
                <div class="col-lg-5 text-center">
                    <img class="welcome-illustration img-fluid"
                         src="~/images/Illustration.png"
                         alt="Library Illustration" style="max-height:200px;" />
                </div>
            </div>
        </div>
    </div>

    <!-- Stats -->
    <div class="row g-3 mb-4">
        <!-- Borrowers -->
        <div class="col-12 col-md-6 col-xl-3">
            <div class="card stat-card-new accent-indigo">
                <div class="card-body">
                    <div class="stat-header">
                        <i class="ri-team-fill stat-icon"></i>
                        <div class="stat-label">Borrowers</div>
                    </div>
                    <div class="stat-value">@Model.TotalBorrowers</div>
                </div>
            </div>
        </div>

        <!-- Books -->
        <div class="col-12 col-md-6 col-xl-3">
            <div class="card stat-card-new accent-purple">
                <div class="card-body">
                    <div class="stat-header">
                        <i class="ri-book-2-fill stat-icon"></i>
                        <div class="stat-label">Books</div>
                    </div>
                    <div class="stat-value">@Model.TotalBooks</div>
                </div>
            </div>
        </div>

        <!-- Transactions -->
        <div class="col-12 col-md-6 col-xl-3">
            <div class="card stat-card-new accent-green">
                <div class="card-body">
                    <div class="stat-header">
                        <i class="ri-arrow-up-down-fill stat-icon"></i>
                        <div class="stat-label">Transactions</div>
                    </div>
                    <div class="stat-value">@Model.TotalTransactions</div>
                </div>
            </div>
        </div>

        <!-- Overdue -->
        <div class="col-12 col-md-6 col-xl-3">
            <div class="card stat-card-new accent-cyan">
                <div class="card-body">
                    <div class="stat-header">
                        <i class="ri-time-fill stat-icon"></i>
                        <div class="stat-label">Overdue</div>
                    </div>
                    <div class="stat-value">@Model.TotalOverdue</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lower cards -->
    <div class="row g-4">
        <!-- Borrowed Books Chart -->
        <div class="col-12 col-xl-6">
            <div class="card shadow-sm h-100">
                <div class="card-body p-3 p-lg-4">

                    <!-- Header with filters -->
                    <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
                        <h6 class="text-primary fw-semibold mb-2 mb-sm-0">Books Borrowed</h6>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary active" data-range="d">Days</button>
                            <button type="button" class="btn btn-outline-primary" data-range="w">Weeks</button>
                            <button type="button" class="btn btn-outline-primary" data-range="m">Months</button>
                            <button type="button" class="btn btn-outline-primary" data-range="y">Years</button>
                        </div>
                    </div>

                    <!-- Custom Date Range -->
                    <div class="row g-2 mb-3 align-items-center">
                        <div class="col-6 col-md-4">
                            <input type="date" id="startDate" class="form-control form-control-sm" />
                        </div>
                        <div class="col-6 col-md-4">
                            <input type="date" id="endDate" class="form-control form-control-sm" />
                        </div>
                        <div class="col-12 col-md-4">
                            <button id="applyRange" class="btn btn-sm btn-primary w-100">Apply</button>
                        </div>
                    </div>

                    <!-- Chart -->
                    <div class="chart-container d-flex justify-content-center align-items-center" style="height:280px;">
                        <canvas id="booksBorrowedChart" style="max-width:100%;"></canvas>
                    </div>


                    <!-- Total Summary -->
                    <div class="mt-3 text-center">
                        <small class="text-muted d-block">Total Borrowed in Range</small>
                        <h6 class="fw-bold mb-0"><span id="totalBorrowed">0</span></h6>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Borrowed Books -->
        <div class="col-12 col-xl-5">
            <div class="card h-100">
                <div class="card-body p-3 p-lg-4">
                    <h6 class="mb-3">Top Borrowed Books</h6>
                    <div class="table-responsive">
                        <table class="table align-middle mb-0 text-center">
                            <thead>
                                <tr>
                                    <th scope="col">Rank</th>
                                    <th scope="col">Book Title</th>
                                    <th scope="col">Total Borrowed</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    var topBooks = Model.TopBorrowedBooks.Cast<dynamic>().ToList();
                                    int rank = 1;
                                    if (topBooks.Any())
                                    {
                                        foreach (var book in topBooks)
                                        {
                                            <tr>
                                                <td>@rank</td>
                                                <td>@book.BookTitle</td>
                                                <td><span class="badge bg-primary">@book.BorrowCount</span></td>
                                            </tr>
                                            rank++;
                                        }
                                    }
                                    else
                                    {
                                        <tr><td colspan="3">No data available</td></tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>
<script>
    let ctx = document.getElementById("booksBorrowedChart").getContext("2d");
    let booksChart = new Chart(ctx, {
        type: "line",
        data: {
            labels: [],
            datasets: [{
                label: "Borrowed Books",
                data: [],
                borderColor: "#4e73df",
                backgroundColor: "rgba(78, 115, 223, 0.15)",
                fill: true,
                tension: 0.3,
                pointRadius: 3
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: true } },
            scales: {
                x: { title: { display: true, text: "Period" } },
                y: { title: { display: true, text: "Books Borrowed" }, beginAtZero: true }
            }
        }
    });

    // Load chart data
    async function loadChart(range = "d") {
        const response = await fetch(`/Admin/Dashboard/GetBorrowedBooks?range=${range}`);
        const data = await response.json();

        booksChart.data.labels = data.map(x => x.label);
        booksChart.data.datasets[0].data = data.map(x => x.total);

        // Change X-axis title dynamically
        switch (range) {
            case "d":
                booksChart.options.scales.x.title.text = "Days (Mon–Fri)";
                break;
            case "w":
                booksChart.options.scales.x.title.text = "Weeks of Current Month";
                break;
            case "m":
                booksChart.options.scales.x.title.text = "Months (Jan–Dec)";
                break;
            case "y":
                booksChart.options.scales.x.title.text = "Years";
                break;
        }

        booksChart.update();

        // Update total
        const total = data.reduce((sum, x) => sum + x.total, 0);
        document.getElementById("totalBorrowed").textContent = total;
    }

    // Default load
    loadChart("d");

    // Handle quick range buttons
    document.querySelectorAll("[data-range]").forEach(btn => {
        btn.addEventListener("click", () => {
            document.querySelectorAll("[data-range]").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            loadChart(btn.dataset.range);
        });
    });

    // Handle custom range
    document.getElementById("applyRange").addEventListener("click", async () => {
        const start = document.getElementById("startDate").value;
        const end = document.getElementById("endDate").value;

        if (!start || !end) {
            alert("Please select both start and end dates.");
            return;
        }

        const response = await fetch(`/Admin/Dashboard/GetBorrowedByRange?start=${start}&end=${end}`);
        const data = await response.json();

        booksChart.data.labels = data.map(x => new Date(x.label).toLocaleDateString());
        booksChart.data.datasets[0].data = data.map(x => x.total);

        booksChart.options.scales.x.title.text = "Custom Date Range";
        booksChart.update();

        // Update total
        const total = data.reduce((sum, x) => sum + x.total, 0);
        document.getElementById("totalBorrowed").textContent = total;

        // Reset button states
        document.querySelectorAll("[data-range]").forEach(b => b.classList.remove("active"));
    });
</script>
