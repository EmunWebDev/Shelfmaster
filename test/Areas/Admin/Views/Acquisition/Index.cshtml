@using test.Enums
@using X.PagedList.Mvc.Core
@model X.PagedList.IPagedList<test.Entity.Acquisition>

@{
    ViewData["Title"] = "Acquisition Requests";
    ViewData["Navigation Title"] = "Acquisition Requests";
    bool isAdmin = ViewBag.IsAdmin ?? false;
}


<div class="row mt-5 g-3">
    <div class="col-12">
        <!-- Search Bar -->
        <div class="row g-0 mb-3">
            <!-- Search -->
            <div class="col-md-6">
                <form asp-controller="Acquisition" asp-action="Index" method="get" class="d-flex">
                    <div class="input-group">
                        <button class="btn bg-color3" id="search" type="submit">
                            <i class="ri-search-line"></i>
                        </button>
                        <input type="text" name="searchQuery" value="@Context.Request.Query["searchQuery"]"
                               class="form-control" placeholder="Search by Title, ISBN, Vendor, Author, Publisher, Genre"
                               aria-describedby="search">
                    </div>
                </form>
            </div>

            <!-- Add New Request -->
            <div class="col-md-6 text-end">
                <a asp-action="New"
                   class="btn bg-color3 text-color4 px-3 border-0 d-flex justify-content-center align-items-center d-inline-flex"
                   title="Request New Acquisition"
                   style="border-radius: 15px;">
                    <i class="ri-add-circle-line"></i>
                    <span class="ms-1 fw-bold d-sm-block d-none">New Request</span>
                </a>
            </div>
        </div>


        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="table-responsive mt-3">
                    <table class="table table-striped table-hover">
                        <thead style="background-color: var(--color4); color: white;">
                            <tr>
                                <th>Vendor</th>
                                <th>Book Details</th>
                                <th>Quantity</th>
                                <th>Cost</th>
                                <th>Status</th>
                                <th>Requested By</th>
                                <th>Timeline</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.Any())
                            {
                                @foreach (var acq in Model)
                                {
                                    <tr>
                                        <td><strong>@acq.Vendor?.Name</strong></td>
                                        <td>
                                            <strong>@acq.Title</strong><br />
                                            <small class="text-muted">
                                                @if (!string.IsNullOrEmpty(acq.ISBN))
                                                {
                                                    <span>ISBN: @acq.ISBN</span>
                                        
                                                    <br />
                                                }
                                                @if (acq.PublicationYear.HasValue)
                                                {
                                                    <span>Year: @acq.PublicationYear</span>
                                        
                                                    <br />
                                                }
                                                Author: @acq.AuthorName<br />
                                                Publisher: @acq.PublisherName<br />
                                                Genre: @acq.GenreName
                                            </small>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-primary">@acq.Quantity</span>
                                        </td>
                                        <td>
                                            @if (acq.TotalCost.HasValue)
                                            {
                                                <span>₱@acq.TotalCost.Value.ToString("N2")</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">Not specified</span>
                                            }
                                        </td>
                                        <td>
                                            @{
                                                string badgeClass = acq.Status switch
                                                {
                                                    AcquisitionStatus.Requested => "bg-warning text-dark",
                                                    AcquisitionStatus.Approved => "bg-info",
                                                    AcquisitionStatus.Rejected => "bg-danger",
                                                    AcquisitionStatus.Delivered => "bg-primary",
                                                    AcquisitionStatus.Checked => "bg-secondary",
                                                    AcquisitionStatus.Catalogued => "bg-success",
                                                    _ => "bg-secondary"
                                                };
                                            }
                                            <span class="badge @badgeClass">
                                                @(acq.Status == AcquisitionStatus.Checked ? "Checked" : acq.Status.ToString())
                                            </span>
                                        </td>
                                        <td>
                                            <small>@acq.RequestedBy?.Username</small><br />
                                            @if (acq.ApprovedBy != null)
                                            {
                                                <small class="text-muted">Approved by: @acq.ApprovedBy.Username</small>
                                            }
                                        </td>
                                        <td>
                                            <small>
                                                <strong>Requested:</strong> @acq.CreatedAt.ToString("MMM dd, yyyy")<br />
                                                @if (acq.ApprovedAt.HasValue)
                                                {
                                                    <strong>Approved:</strong> 
                                                    @acq.ApprovedAt.Value.ToString("MMM dd, yyyy")
                                        
                                                    <br />
                                                }
                                                @if (acq.InspectedAt.HasValue)
                                                {
                                                    <strong>Checked:</strong> 
                                                    @acq.InspectedAt.Value.ToString("MMM dd, yyyy")
                                        
                                                    <br />
                                                }
                                                @if (acq.CataloguedAt.HasValue)
                                                {
                                                    <strong>Catalogued:</strong> 
                                                    @acq.CataloguedAt.Value.ToString("MMM dd, yyyy")
                                                }
                                            </small>
                                        </td>
                                        <td>
                                            <div class="btn-group-vertical btn-group-sm" role="group">
                                                @if (isAdmin)
                                                {
                                                    if (acq.Status == AcquisitionStatus.Requested)
                                                    {
                                                        <form asp-action="Approve" asp-route-id="@acq.Id" method="post" style="display:inline"
                                                              onsubmit="return confirm('Approve this acquisition request?')">
                                                            <button class="btn btn-success btn-sm mb-1" type="submit" title="Approve Request">
                                                                <i class="ri-check-line"></i> Approve
                                                            </button>
                                                        </form>
                                                        <button type="button" class="btn btn-danger btn-sm mb-1"
                                                                data-bs-toggle="modal" data-bs-target="#rejectModal@(acq.Id)" title="Reject Request">
                                                            <i class="ri-close-line"></i> Reject
                                                        </button>
                                                    }
                                                    else if (acq.Status == AcquisitionStatus.Approved)
                                                    {
                                                        <form asp-action="MarkDelivered" asp-route-id="@acq.Id" method="post" style="display:inline"
                                                              onsubmit="return confirm('Mark this request as Delivered?')">
                                                            <button class="btn btn-warning btn-sm mb-1" type="submit" title="Mark as Delivered">
                                                                <i class="ri-truck-line"></i> Deliver
                                                            </button>
                                                        </form>
                                                    }
                                                    else if (acq.Status == AcquisitionStatus.Delivered)
                                                    {
                                                        <form asp-action="Inspect" asp-route-id="@acq.Id" method="post" style="display:inline"
                                                              onsubmit="return confirm('Mark as Checked? This will create/link Author, Publisher, and Genre entities.')">
                                                            <button class="btn btn-primary btn-sm mb-1" type="submit" title="Check Acquisition">
                                                                <i class="ri-search-line"></i> Check
                                                            </button>
                                                        </form>
                                                    }
                                                    else if (acq.Status == AcquisitionStatus.Checked)
                                                    {
                                                        <form asp-action="Catalog" asp-route-id="@acq.Id" method="post" style="display:inline"
                                                              onsubmit="return confirm('Catalog this book? This will create the book record and copies with QR codes.')">
                                                            <button class="btn btn-dark btn-sm mb-1" type="submit" title="Catalog Book">
                                                                <i class="ri-book-line"></i> Catalog
                                                            </button>
                                                        </form>
                                                    }
                                                }

                                                <!-- Details button always visible -->
                                                <a asp-action="Details" asp-route-id="@acq.Id"
                                                   class="btn bg-white border border-color3 text-color3 btn-sm fw-semibold"
                                                   title="View Details"
                                                   style="border-radius: 10px; transition: 0.3s;">
                                                    <i class="ri-eye-line"></i> Details
                                                </a>

                                            </div>

                                            <!-- Reject Modal -->
                                            @if (isAdmin && acq.Status == AcquisitionStatus.Requested)
                                            {
                                                <div class="modal fade" id="rejectModal@(acq.Id)" tabindex="-1">
                                                    <div class="modal-dialog">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h5 class="modal-title">Reject Acquisition Request</h5>
                                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                            </div>
                                                            <form asp-action="Reject" asp-route-id="@acq.Id" method="post">
                                                                <div class="modal-body">
                                                                    <p><strong>Book:</strong> @acq.Title</p>
                                                                    <p><strong>Author:</strong> @acq.AuthorName</p>
                                                                    <div class="mb-3">
                                                                        <label for="notes@(acq.Id)" class="form-label">Rejection Reason</label>
                                                                        <textarea name="notes" id="notes@(acq.Id)" class="form-control" rows="3"
                                                                      placeholder="Please provide a reason..." required></textarea>
                                                                    </div>
                                                                </div>
                                                                <div class="modal-footer">
                                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                                    <button type="submit" class="btn btn-danger">Reject</button>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        </td>

                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="8" class="text-center text-muted">No acquisition requests found.</td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    <!-- Pagination -->
                    <div class="d-flex justify-content-end mt-3">
                        @Html.PagedListPager(Model, page => Url.Action("Index", new { page, searchQuery = Context.Request.Query["searchQuery"] }),
                        new PagedListRenderOptions
                        {
                            LiElementClasses = new[] { "page-item", "custom-page-item" },
                            PageClasses = new[] { "page-link", "custom-page-link" }
                        })
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* Status Legend *@
<div class="row mt-3">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body py-2">
                <small class="text-muted">
                    <strong>Status Legend:</strong>
                    <span class="badge bg-warning text-dark ms-2">Requested</span>
                    <span class="badge bg-info ms-1">Approved</span>
                    <span class="badge bg-primary ms-1">Delivered</span>
                    <span class="badge bg-secondary ms-1">Checked</span>
                    <span class="badge bg-success ms-1">Catalogued</span>
                    <span class="badge bg-danger ms-1">Rejected</span>
                </small>
            </div>
        </div>
    </div>
</div>


