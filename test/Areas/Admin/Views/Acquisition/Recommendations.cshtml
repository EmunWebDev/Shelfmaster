@model IEnumerable<test.Areas.Admin.Models.RecommendationViewModel>

@{
    ViewData["Title"] = "Book Recommendations";
    ViewData["Navigation Title"] = "Book Recommendations";

    var acquisitionTitles = ViewBag.AcquisitionTitles as List<string> ?? new List<string>();
    var vendors = ViewBag.Vendors as List<string> ?? new List<string>();
}

<div class="row mt-5 g-3">
    <div class="col-12">

        <!-- Filters -->
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label fw-bold">Filter by Title</label>
                <select class="form-select" id="filterTitle" onchange="filterTable()">
                    <option value="">-- All Titles --</option>
                    @foreach (var title in acquisitionTitles.OrderBy(t => t))
                    {
                        <option value="@title">@title</option>
                    }
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label fw-bold">Filter by Vendor</label>
                <select class="form-select" id="filterVendor" onchange="filterTable()">
                    <option value="">-- All Vendors --</option>
                    @foreach (var vendor in vendors.OrderBy(v => v))
                    {
                        <option value="@vendor">@vendor</option>
                    }
                </select>
            </div>
        </div>

        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="table-responsive mt-3">
                    <table class="table table-striped table-hover" id="recommendationTable">
                        <thead style="background-color: var(--color4); color: white;">
                            <tr>
                                <th>Book Title</th>
                                <th>Total Copies</th>
                                <th>Available</th>
                                <th>Lost/Damaged</th>
                                <th>Last Borrowed</th>
                                <th>Acquired On</th>
                                <th>Status</th>
                                <th>Vendor</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var book in Model)
                            {
                                <tr>
                                    <td><strong>@book.Title</strong></td>
                                    <td class="text-center">
                                        <span class="badge bg-primary">@book.TotalCopies</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-success">@book.AvailableCopies</span>
                                    </td>
                                    <td class="text-center">
                                        @if (book.LostCopies > 0)
                                        {
                                            <span class="badge bg-danger">@book.LostCopies</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">0</span>
                                        }
                                    </td>
                                    <td>
                                        @if (book.LastTransaction.HasValue)
                                        {
                                            <small>@book.LastTransaction.Value.ToString("MMM dd, yyyy")</small>
                                        }
                                        else
                                        {
                                            <small class="text-muted">Never Borrowed</small>
                                        }
                                    </td>
                                    <td><small>@book.AcquisitionDate.ToString("MMM dd, yyyy")</small></td>
                                    <td>
                                        @if (book.NeedsReacquire)
                                        {
                                            <span class="badge bg-danger">Reacquire Needed</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-success">Sufficient</span>
                                        }
                                    </td>
                                    <td><small>@book.VendorName</small></td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    @if (!Model.Any())
                    {
                        <div class="text-center py-5">
                            <i class="ri-lightbulb-line" style="font-size: 3rem; color: #ccc;"></i>
                            <p class="text-muted mt-3">No recommendations at the moment. Your collection looks good!</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Legend -->
<div class="row mt-3">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body py-2">
                <small class="text-muted">
                    <strong>Status Legend:</strong>
                    <span class="badge bg-danger ms-1">Reacquire Needed</span>
                    <span class="badge bg-success ms-1">Sufficient</span>
                </small>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function filterTable() {
            var titleFilter = document.getElementById("filterTitle").value.toLowerCase();
            var vendorFilter = document.getElementById("filterVendor").value.toLowerCase();
            var table = document.getElementById("recommendationTable");
            var rows = table.getElementsByTagName("tr");

            for (var i = 1; i < rows.length; i++) {
                var cells = rows[i].getElementsByTagName("td");
                var title = cells[0]?.innerText.toLowerCase() || "";
                var vendor = cells[7]?.innerText.toLowerCase() || "";

                if ((titleFilter === "" || title.includes(titleFilter)) &&
                    (vendorFilter === "" || vendor.includes(vendorFilter))) {
                    rows[i].style.display = "";
                } else {
                    rows[i].style.display = "none";
                }
            }
        }
    </script>
}
